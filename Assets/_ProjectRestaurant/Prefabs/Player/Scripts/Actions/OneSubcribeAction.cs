using System;

/// <summary>
/// Представляет эксклюзивное действие, поддерживающее только одного подписчика.
/// При новой подписке предыдущий подписчик автоматически заменяется.
/// Реализация является потокобезопасной.
/// </summary>
public class OneSubcribeAction
{
    private Action _currentHandler;
    private readonly object _lock = new object();

    /// <summary>
    /// Вызывает зарегистрированный обработчик события, если он существует.
    /// Если подписчик не зарегистрирован, метод не выполняет никаких действий.
    /// Операция является потокобезопасной.
    /// </summary>
    public void Invoke()
    {
        lock (_lock)
        {
            _currentHandler?.Invoke();
        }
    }

    /// <summary>
    /// Регистрирует новый обработчик события, заменяя предыдущий подписчик, если он существовал.
    /// Если передается null, текущий подписчик будет удален (эквивалентно вызову Unsubscribe).
    /// Операция является потокобезопасной.
    /// </summary>
    public void Subscribe(Action handler)
    {
        lock (_lock)
        {
            _currentHandler = handler;
        }
    }

    /// <summary>
    /// Отменяет регистрацию указанного обработчика, если он в данный момент является активным подписчиком.
    /// Если переданный обработчик не является текущим подписчиком, метод не выполняет никаких действий.
    /// Операция является потокобезопасной.
    /// </summary>
    public void Unsubscribe(Action handler)
    {
        lock (_lock)
        {
            // Отписываем только если переданный обработчик является текущим
            if (_currentHandler == handler)
            {
                _currentHandler = null;
            }
        }
    }

    /// <summary>
    /// Полностью очищает текущего подписчика, если он существует.
    /// Операция является потокобезопасной.
    /// </summary>
    public void Clear()
    {
        lock (_lock)
        {
            _currentHandler = null;
        }
    }
}
